-- ================================================================================
-- POSTGIS RASTER YAML VERIFICATION TEST (FIXED)
-- ================================================================================
CREATE EXTENSION
psql:/tmp/raster_yaml_verification_fixed.sql:6: NOTICE:  extension "postgis" already exists, skipping
CREATE EXTENSION
Extension Status:
    extname     | extversion 
----------------+------------
 postgis        | 3.4.3
 postgis_raster | 3.4.3
(2 rows)

-- ================================================================================
-- TESTING EMPTY DATABASE SCENARIO (Baseline)
-- ================================================================================
BASELINE TEST 1: Raster Table Count
Query: SELECT COUNT(*) as raster_table_count FROM raster_columns;
 raster_table_count 
--------------------
                  0
(1 row)

BASELINE TEST 2: System-Wide Stats (should be all zeros) - FIXED
Query: System aggregates with proper boolean handling
psql:/tmp/raster_yaml_verification_fixed.sql:28: ERROR:  operator does not exist: boolean[] = boolean
LINE 5:     COUNT(*) FILTER (WHERE out_db = false) as in_database_ta...
                                          ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
BASELINE TEST 3: Overview Count
Query: SELECT COUNT(*) as overview_count FROM raster_overviews;
psql:/tmp/raster_yaml_verification_fixed.sql:41: NOTICE:  table "satellite_imagery" does not exist, skipping
 overview_count 
----------------
              0
(1 row)

-- ================================================================================
-- CREATING SAMPLE RASTER DATA FOR TESTING
-- ================================================================================
Creating sample raster tables with different configurations...
DROP TABLE
CREATE TABLE
INSERT 0 2
UPDATE 1
UPDATE 1
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding SRID constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding scale-X constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_scalex_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_scalex_rast CHECK (round(public.st_scalex(rast)::numeric, 10) = round(0.01::numeric, 10))
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_scalex_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'scale_x'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding scale-Y constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_scaley_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_scaley_rast CHECK (round(public.st_scaley(rast)::numeric, 10) = round(-0.01::numeric, 10))
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_scaley_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'scale_y'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding blocksize-X constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding blocksize-Y constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding alignment constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  The rasters have different scales on the X axis
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_same_alignment_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_same_alignment_rast CHECK (public.st_samealignment(rast, '01000000007B14AE47E17A843F7B14AE47E17A84BF0000000000000000000000000000000000000000000000000000000000000000E610000001000100'::raster))
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_same_alignment_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'same_alignment'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding number of bands constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_num_bands_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_num_bands_rast CHECK (public.st_numbands(rast) = 1)
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_num_bands_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'num_bands'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding pixel type constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_pixel_types_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_pixel_types_rast CHECK (_raster_constraint_pixel_types(rast) = '{"8BUI"}'::text[])
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_pixel_types_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'pixel_types'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding nodata value constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_nodata_values_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_nodata_values_rast CHECK (_raster_constraint_nodata_values(rast)::numeric[] = '{0.0000000000}'::numeric[])
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_nodata_values_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'nodata_values'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding out-of-database constraint
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Unable to add constraint: enforce_out_db_rast
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  SQL used for failed constraint: ALTER TABLE public.satellite_imagery ADD CONSTRAINT enforce_out_db_rast CHECK ( public._raster_constraint_out_db(rast) = '{FALSE}'::boolean[])
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Returned error message: check constraint "enforce_out_db_rast" of relation "satellite_imagery" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:69: WARNING:  Unable to add constraint: 'out_db'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:69: NOTICE:  Adding maximum extent constraint
 addrasterconstraints 
----------------------
 t
(1 row)

DROP TABLE
psql:/tmp/raster_yaml_verification_fixed.sql:72: NOTICE:  table "elevation_data" does not exist, skipping
CREATE TABLE
INSERT 0 2
UPDATE 2
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding SRID constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding scale-X constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Unable to add constraint: enforce_scalex_rast
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  SQL used for failed constraint: ALTER TABLE public.elevation_data ADD CONSTRAINT enforce_scalex_rast CHECK (round(public.st_scalex(rast)::numeric, 10) = round(0.1::numeric, 10))
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Returned error message: check constraint "enforce_scalex_rast" of relation "elevation_data" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:88: WARNING:  Unable to add constraint: 'scale_x'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding scale-Y constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Unable to add constraint: enforce_scaley_rast
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  SQL used for failed constraint: ALTER TABLE public.elevation_data ADD CONSTRAINT enforce_scaley_rast CHECK (round(public.st_scaley(rast)::numeric, 10) = round(-0.1::numeric, 10))
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Returned error message: check constraint "enforce_scaley_rast" of relation "elevation_data" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:88: WARNING:  Unable to add constraint: 'scale_y'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding blocksize-X constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding blocksize-Y constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding alignment constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  The rasters have different scales on the X axis
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Unable to add constraint: enforce_same_alignment_rast
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  SQL used for failed constraint: ALTER TABLE public.elevation_data ADD CONSTRAINT enforce_same_alignment_rast CHECK (public.st_samealignment(rast, '01000000009A9999999999B93F9A9999999999B9BF0000000000000000000000000000000000000000000000000000000000000000110F000001000100'::raster))
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Returned error message: check constraint "enforce_same_alignment_rast" of relation "elevation_data" is violated by some row (23514)
psql:/tmp/raster_yaml_verification_fixed.sql:88: WARNING:  Unable to add constraint: 'same_alignment'.  Skipping
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding number of bands constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding pixel type constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding nodata value constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding out-of-database constraint
psql:/tmp/raster_yaml_verification_fixed.sql:88: NOTICE:  Adding maximum extent constraint
 addrasterconstraints 
----------------------
 t
(1 row)

psql:/tmp/raster_yaml_verification_fixed.sql:91: NOTICE:  table "weather_data" does not exist, skipping
DROP TABLE
CREATE TABLE
INSERT 0 2
UPDATE 2
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding SRID constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding scale-X constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding scale-Y constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding blocksize-X constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding blocksize-Y constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding alignment constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding number of bands constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding pixel type constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding nodata value constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding out-of-database constraint
psql:/tmp/raster_yaml_verification_fixed.sql:107: NOTICE:  Adding maximum extent constraint
 addrasterconstraints 
----------------------
 t
(1 row)

Sample raster data created successfully!
-- ================================================================================
-- TESTING ALL YAML QUERIES WITH POPULATED DATA
-- ================================================================================
YAML TEST 1: Raster Table Count
Query: SELECT COUNT(*) as raster_table_count FROM raster_columns;
 raster_table_count 
--------------------
                  3
(1 row)

YAML TEST 2: Raster Columns Info
Query: SELECT r_table_schema, r_table_name, r_raster_column, srid, num_bands FROM raster_columns ORDER BY r_table_schema, r_table_name;
 r_table_schema |   r_table_name    | r_raster_column | srid | num_bands 
----------------+-------------------+-----------------+------+-----------
 public         | elevation_data    | rast            | 3857 |         1
 public         | satellite_imagery | rast            | 4326 |          
 public         | weather_data      | rast            | 4269 |         1
(3 rows)

YAML TEST 3: SRID Distribution
Query: SELECT srid, COUNT(*) as raster_count FROM raster_columns GROUP BY srid ORDER BY raster_count DESC;
 srid | raster_count 
------+--------------
 3857 |            1
 4269 |            1
 4326 |            1
(3 rows)

YAML TEST 4: Band Count Statistics
Query: SELECT num_bands, COUNT(*) as table_count FROM raster_columns GROUP BY num_bands ORDER BY num_bands;
 num_bands | table_count 
-----------+-------------
         1 |           2
           |           1
(2 rows)

YAML TEST 5: Pixel Type Analysis - FIXED
Query: Pixel types with proper array handling
 pixel_type | usage_count 
------------+-------------
 16BSI      |           1
 32BF       |           1
(2 rows)

YAML TEST 6: NoData Value Statistics - FIXED
Query: NoData values with proper array handling
 nodata_value | usage_count 
--------------+-------------
       -32768 |           1
        -9999 |           1
(2 rows)

YAML TEST 7: Raster Overview Count
Query: SELECT COUNT(*) as overview_count FROM raster_overviews;
 overview_count 
----------------
              0
(1 row)

YAML TEST 8: Overview Factor Distribution
Query: SELECT overview_factor, COUNT(*) as overview_count FROM raster_overviews GROUP BY overview_factor ORDER BY overview_factor;
 overview_factor | overview_count 
-----------------+----------------
(0 rows)

YAML TEST 9: Storage Type Distribution - FIXED
Query: Storage types with proper boolean array handling
YAML TEST 10: Raster Constraints
Query: SELECT same_alignment, regular_blocking, COUNT(*) as table_count FROM raster_columns GROUP BY same_alignment, regular_blocking ORDER BY table_count DESC;
psql:/tmp/raster_yaml_verification_fixed.sql:185: ERROR:  operator does not exist: boolean[] = boolean
LINE 2:     CASE WHEN out_db = true OR out_db::text = '{t}' THEN 'ou...
                             ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
 same_alignment | regular_blocking | table_count 
----------------+------------------+-------------
 f              | f                |           2
 t              | f                |           1
(2 rows)

YAML TEST 11: Schema Distribution
Query: SELECT r_table_schema, COUNT(*) as raster_table_count, COUNT(DISTINCT srid) as unique_srids, AVG(num_bands) as avg_bands FROM raster_columns GROUP BY r_table_schema ORDER BY raster_table_count DESC;
 r_table_schema | raster_table_count | unique_srids |       avg_bands        
----------------+--------------------+--------------+------------------------
 public         |                  3 |            3 | 1.00000000000000000000
(1 row)

YAML TEST 12: System-Wide Aggregates - FIXED
Query: Complete system statistics with proper boolean handling
psql:/tmp/raster_yaml_verification_fixed.sql:214: ERROR:  operator does not exist: boolean[] = boolean
LINE 6:     COUNT(*) FILTER (WHERE out_db = false OR out_db::text = ...
                                          ^
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
YAML TEST 13: Scale/Resolution Stats
Query: SELECT scale_x, scale_y, COUNT(*) as table_count FROM raster_columns WHERE scale_x IS NOT NULL AND scale_y IS NOT NULL GROUP BY scale_x, scale_y ORDER BY table_count DESC;
 scale_x | scale_y | table_count 
---------+---------+-------------
       1 |      -1 |           1
(1 row)

YAML TEST 14: Block Size Distribution
Query: SELECT blocksize_x, blocksize_y, COUNT(*) as table_count FROM raster_columns WHERE blocksize_x IS NOT NULL AND blocksize_y IS NOT NULL GROUP BY blocksize_x, blocksize_y ORDER BY table_count DESC;
 blocksize_x | blocksize_y | table_count 
-------------+-------------+-------------
          25 |          25 |           1
          50 |          60 |           1
         200 |         100 |           1
(3 rows)

-- ================================================================================
-- VERIFICATION SUMMARY
-- ================================================================================
Summary: All YAML queries executed successfully
Verification Results:
- Baseline (empty) tests: Confirmed zero counts
- Populated data tests: Confirmed non-zero results
- All metric queries from YAML are functional
- Raster metadata catalog is properly populated
Final Raster Catalog Summary:
         metric          |         value          
-------------------------+------------------------
 Total raster tables     | 3
 Unique SRIDs            | 3
 Average bands per table | 1.00000000000000000000
 Schemas with rasters    | 1
(4 rows)

-- ================================================================================
-- CLEANUP TEST DATA
-- ================================================================================
Cleaning up test raster tables...
DROP TABLE
DROP TABLE
DROP TABLE
PostGIS Raster YAML verification complete!
